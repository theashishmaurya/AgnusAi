services:
  traefik:
    image: traefik:v3.6.9
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.filename=/traefik/dynamic.yml"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--accesslog=true"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic.yml:/traefik/dynamic.yml:ro
      - /etc/nginx/ssl:/etc/nginx/ssl:ro
    labels:
      - "traefik.enable=false"
    restart: unless-stopped
    networks:
      - agnus-network

  agnus:
    build: .
    environment:
      - DATABASE_URL=postgres://agnus:agnus@postgres:5432/agnus
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}
      - API_KEY=${API_KEY:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      - LLM_MODEL=${LLM_MODEL:-qwen3.5:397b-cloud}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434/v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY:-}
      - AZURE_API_VERSION=${AZURE_API_VERSION:-2025-01-01-preview}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CUSTOM_LLM_URL=${CUSTOM_LLM_URL:-}
      - CUSTOM_LLM_API_KEY=${CUSTOM_LLM_API_KEY:-}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-}
      - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL:-}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY:-}
      - REVIEW_DEPTH=${REVIEW_DEPTH:-standard}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - PUBLIC_URL=${PUBLIC_URL:-https://agnusai.platformnx.com}
      - BASE_URL=${BASE_URL:-https://agnusai.platformnx.com}
      - FEEDBACK_SECRET=${FEEDBACK_SECRET:-}
      # Rate limiting / abuse protection
      - TRUST_PROXY=${TRUST_PROXY:-true}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_GLOBAL_MAX=${RATE_LIMIT_GLOBAL_MAX:-300}
      - RATE_LIMIT_GLOBAL_WINDOW=${RATE_LIMIT_GLOBAL_WINDOW:-1 minute}
      - RATE_LIMIT_AUTH_MAX=${RATE_LIMIT_AUTH_MAX:-20}
      - RATE_LIMIT_AUTH_WINDOW=${RATE_LIMIT_AUTH_WINDOW:-1 minute}
      - RATE_LIMIT_SIGNUP_MAX=${RATE_LIMIT_SIGNUP_MAX:-5}
      - RATE_LIMIT_SIGNUP_WINDOW=${RATE_LIMIT_SIGNUP_WINDOW:-10 minutes}
      - RATE_LIMIT_CHECK_ORG_MAX=${RATE_LIMIT_CHECK_ORG_MAX:-20}
      - RATE_LIMIT_CHECK_ORG_WINDOW=${RATE_LIMIT_CHECK_ORG_WINDOW:-1 minute}
      - RATE_LIMIT_WEBHOOK_MAX=${RATE_LIMIT_WEBHOOK_MAX:-120}
      - RATE_LIMIT_WEBHOOK_WINDOW=${RATE_LIMIT_WEBHOOK_WINDOW:-1 minute}
      - HOST_ID=host.docker.internal
    volumes:
      - /tmp:/tmp:ro
      - repos-data:/repos
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.agnus-api.rule=PathPrefix(`/`)"
      - "traefik.http.routers.agnus-api.entrypoints=websecure"
      - "traefik.http.routers.agnus-api.tls=true"
      - "traefik.http.routers.agnus-api.service=agnus-api"
      - "traefik.http.services.agnus-api.loadbalancer.server.port=3000"
      - "traefik.http.routers.agnus-health.rule=Path(`/health`)"
      - "traefik.http.routers.agnus-health.entrypoints=websecure"
      - "traefik.http.routers.agnus-health.tls=true"
      - "traefik.http.routers.agnus-health.service=agnus-health"
      - "traefik.http.services.agnus-health.loadbalancer.server.port=3000"
    networks:
      - agnus-network

  postgres:
    image: pgvector/pgvector:pg16
    environment:
      - POSTGRES_USER=agnus
      - POSTGRES_PASSWORD=agnus
      - POSTGRES_DB=agnus
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agnus"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks:
      - agnus-network

networks:
  agnus-network:
    driver: bridge

volumes:
  postgres-data:
  repos-data:
  # ollama-data:  # Uncomment if using Ollama
